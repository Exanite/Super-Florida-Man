name: Build Docker Image

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

defaults:
  run:
    shell: powershell

jobs:
  # Build Docker Image
  build:
    name: Build Docker Image
    runs-on: windows-2022
    steps:

    # Log Disk Space
    - name: Log Disk Space
      shell: bash
      run: df -h

    # Install ue4-docker
    - name: Install ue4-docker
      run: pip install ue4-docker
      
    # Docker - Close Docker
    - name: Docker - Close Docker
      run: Stop-Service *docker*

    # Docker - Edit Daemon Configuration
    - name: Docker - Configure Max Container Size
      run: | 
          Set-Content -Path C:\ProgramData\Docker\config\daemon.json -Value '{
            "registry-mirrors": [],
            "insecure-registries": [],
            "debug": false,
            "experimental": false,
            "storage-opts": [
              "size=400GB"
            ]
          }' >> test.txt

    # Docker - Restart Docker
    - name: Docker - Restart Docker
      run: Start-Service *docker*

    # Build Unreal Engine Image
    - name: Build Unreal Engine Image
      run: ue4-docker build 4.27.0 --visual-studio 2019 --no-full --no-engine -username ${{ secrets.GH_USERNAME }} -password ${{ secrets.GH_TOKEN }}
