name: Build Docker Image

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

defaults:
  run:
    shell: powershell

jobs:
  # Build Docker Image
  build:
    name: Build Docker Image
    runs-on: windows-2022
    steps:

    # Login to Github
    - name: Login to Github
      run: echo ${{ secrets.GH_TOKEN }} | gh auth login --with-token

    # Login to Docker
    - name: Login to Docker
      run: echo ${{ secrets.DOCKER_TOKEN }} | docker login --username ${{ secrets.DOCKER_USERNAME }} --password-stdin

    # Install ue4-docker
    - name: Install ue4-docker
      run: pip install ue4-docker
      
    # Docker - Close Docker
    - name: Docker - Close Docker
      run: Stop-Service *docker*

    # Docker - Edit Daemon Configuration
    - name: Docker - Configure Max Container Size
      run: | 
        Set-Content -Path C:\ProgramData\Docker\config\daemon.json -Value '{
          "registry-mirrors": [],
          "insecure-registries": [],
          "debug": false,
          "experimental": false,
          "storage-opts": [
            "size=400GB"
          ]
        }' >> test.txt

    # Docker - Restart Docker
    - name: Docker - Restart Docker
      run: Start-Service *docker*

    # Build Unreal Engine Image
    - name: Build Unreal Engine Image
      run: ue4-docker build 4.27.0 -basetag ltsc2022 --visual-studio 2019 --no-full --no-engine -username ${{ secrets.GH_USERNAME }} -password ${{ secrets.GH_TOKEN }}
      
    # Push Unreal Engine Image to Docker Repository
    - name: Push Unreal Engine Image to Docker Repository
      run: |
        docker image tag adamrehn/ue4-minimal:4.27.0-ltsc2022-vs2019 ${{ secrets.DOCKER_REPOSITORY }}:unreal-engine-4.27.0 ;
        docker image push ${{ secrets.DOCKER_REPOSITORY }}:unreal-engine-4.27.0
        
